<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor demo - SunEditor</title>
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px; /* Prevents iOS auto-zoom */
            margin: 0;
            padding: 8px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 900px;
            margin: 15px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sun-editor {
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Editor demo - SunEditor</h2>
        <p>Features: toolbar wrapping on mobile, iOS selection/insertion, load content from file.</p>
        <textarea id="editor"></textarea>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script>
        // -- DEFINE TOOLBAR LAYOUTS --
        const desktopToolbar = [
            ['undo', 'redo'], ['font', 'fontSize', 'formatBlock'], ['paragraphStyle', 'blockquote'],
            ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
            ['fontColor', 'hiliteColor', 'textStyle'], ['removeFormat'], ['outdent', 'indent'],
            ['align', 'horizontalRule', 'list', 'lineHeight'], ['table', 'link', 'image', 'video', 'audio'],
            ['fullScreen', 'showBlocks', 'codeView'], ['preview', 'print']
        ];

        const mobileToolbar = [
            ['undo', 'redo'],
            [':r-Format-default.more_plus', 'font', 'fontSize', 'formatBlock', 'bold', 'underline', 'italic', 'fontColor', 'hiliteColor', 'removeFormat'],
            [':l-Paragraph-default.more_paragraph', 'paragraphStyle', 'blockquote', 'outdent', 'indent', 'align', 'list', 'lineHeight'],
            [':i-Insert-default.more_plus', 'table', 'link', 'image', 'video', 'audio', 'horizontalRule'],
            ['fullScreen', 'codeView']
        ];

        // -- EDITOR INITIALIZATION --
        const isMobile = window.innerWidth < 768;
        
        const editor = SUNEDITOR.create('editor', {
            buttonList: isMobile ? mobileToolbar : desktopToolbar,
            width: '100%',
            height: 'auto',
            minHeight: '250px',
            placeholder: 'Start writing here...',
            defaultTag: 'p',
            
            // **CRITICAL FIX FOR SELECTION ISSUES**
            // These callbacks help maintain focus, especially on mobile.
            callBackSave: function () {
                // When the editor saves, it can lose focus. This brings it back.
                this.core.focus();
            },
            onImageUpload: function () {
                // Explicitly focus the editor before the image upload dialog appears.
                // This helps ensure the image is inserted at the correct cursor position.
                this.core.focus();
            }
        });

        // **RE-IMPLEMENTED IOS SELECTION FIX**
        // This is the most important part for fixing the paragraph/image insertion bug.
        // It applies to both iOS and can benefit Android in some cases.
        function applyMobileFocusFix() {
            const toolbar = editor.core.context.tool.bar;
            if (toolbar) {
                // We listen for a "touchend" event on the entire toolbar.
                toolbar.addEventListener('touchend', (e) => {
                    // When the touch ends (i.e., user lifts their finger),
                    // we immediately refocus on the editor's writable area.
                    editor.core.focus();
                });
            }
        }

        // Apply the fix right after the editor is created.
        applyMobileFocusFix();


        // -- RESPONSIVE LOGIC TO SWITCH TOOLBARS --
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const currentWidth = window.innerWidth;
                const isMobileView = currentWidth < 768;
                const currentToolbar = editor.options.buttonList;

                if (isMobileView && (currentToolbar !== mobileToolbar)) {
                    editor.setOptions({ buttonList: mobileToolbar });
                    applyMobileFocusFix(); // Re-apply the fix after rebuilding the toolbar
                } else if (!isMobileView && (currentToolbar !== desktopToolbar)) {
                    editor.setOptions({ buttonList: desktopToolbar });
                }
            }, 100);
        });

        // A workaround for WebKit's selection issues.
        // This ensures that the selection is properly recognized before the editor's command is executed.
        editor.core.context.element.wysiwyg.addEventListener('touchend', function () {
            editor.core.context.element.wysiwyg.focus();
        });

        function loadContentFromFile(fileName) {
            fetch(`assets/${fileName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    editor.setContents(html);
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    editor.setContents(`<p>Error loading content: ${error.message}. Please try again later.</p>`);
                });
        }

        // function loadContentFromFile() {
        //     var xhr = new XMLHttpRequest();
        //     xhr.onreadystatechange = function() {
        //         if (xhr.readyState === 4) {
        //             if (xhr.status === 200) {
        //                 editor.setContents(xhr.responseText);
        //             } else {
        //                 console.error('Error loading content:', xhr.status, xhr.statusText);
        //                 editor.setContents(`<p>Error loading content: ${xhr.status} ${xhr.statusText}. Please try again later.</p>`);
        //             }
        //         }
        //     };
        //     xhr.open('GET', 'assets/content.html', true);
        //     xhr.send();
        // }

        // const loadContentFromFile = async (fileName) => {
        //     // alert(fileName);
        //     try {
        //         const response = await fetch(`assets/${fileName}`);
        //         alert("a");
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }
        //         const contentText = await response.text();
        //         alert("a");
        //         alert(contentText);
                
        //         editor.setContents(contentText);

        //     } catch (error) {
        //         console.error('Error loading markdown file:', error);
        //         contentViewElement.innerHTML = `<p class="error">Sorry, could not load the file: ${fileName}. Please check the console for details.</p>`;
        //     }
        // };

        // Load content after editor initialization
        editor.onload = function (core) {
            console.log('Attempting to load content file...');
            loadContentFromFile('content.html');
        };

    </script>

</body>
</html>