<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunEditor - Final Working Example</title>
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px; /* Prevents iOS auto-zoom */
            margin: 0;
            padding: 8px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 900px;
            margin: 15px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sun-editor {
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>SunEditor Demo</h2>
        <p>Toolbar wrapping is fixed, and iOS selection/insertion issues are now resolved.</p>
        <textarea id="editor"></textarea>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script>
        // -- DEFINE TOOLBAR LAYOUTS --
        const desktopToolbar = [
            ['undo', 'redo'], ['font', 'fontSize', 'formatBlock'], ['paragraphStyle', 'blockquote'],
            ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
            ['fontColor', 'hiliteColor', 'textStyle'], ['removeFormat'], ['outdent', 'indent'],
            ['align', 'horizontalRule', 'list', 'lineHeight'], ['table', 'link', 'image', 'video'],
            ['fullScreen', 'showBlocks', 'codeView'], ['preview', 'print']
        ];

        const mobileToolbar = [
            ['undo', 'redo'],
            [':r-Format-default.more_plus', 'font', 'fontSize', 'formatBlock', 'bold', 'underline', 'italic', 'fontColor', 'hiliteColor', 'removeFormat'],
            [':l-Paragraph-default.more_paragraph', 'paragraphStyle', 'blockquote', 'outdent', 'indent', 'align', 'list', 'lineHeight'],
            [':i-Insert-default.more_plus', 'table', 'link', 'image', 'video', 'horizontalRule'],
            ['fullScreen', 'codeView']
        ];

        // -- EDITOR INITIALIZATION --
        const isMobile = window.innerWidth < 768;
        
        const editor = SUNEDITOR.create('editor', {
            buttonList: isMobile ? mobileToolbar : desktopToolbar,
            width: '100%',
            height: 'auto',
            minHeight: '250px',
            placeholder: 'Start writing here...',
            defaultTag: 'p',
            
            // **CRITICAL FIX FOR SELECTION ISSUES**
            // These callbacks help maintain focus, especially on mobile.
            callBackSave: function () {
                // When the editor saves, it can lose focus. This brings it back.
                this.core.focus();
            },
            onImageUpload: function () {
                // Explicitly focus the editor before the image upload dialog appears.
                // This helps ensure the image is inserted at the correct cursor position.
                this.core.focus();
            }
        });

        // **RE-IMPLEMENTED IOS SELECTION FIX**
        // This is the most important part for fixing the paragraph/image insertion bug.
        // It applies to both iOS and can benefit Android in some cases.
        function applyMobileFocusFix() {
            const toolbar = editor.core.context.tool.bar;
            if (toolbar) {
                // We listen for a "touchend" event on the entire toolbar.
                toolbar.addEventListener('touchend', (e) => {
                    // When the touch ends (i.e., user lifts their finger),
                    // we immediately refocus on the editor's writable area.
                    editor.core.focus();
                });
            }
        }

        // Apply the fix right after the editor is created.
        applyMobileFocusFix();


        // -- RESPONSIVE LOGIC TO SWITCH TOOLBARS --
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const currentWidth = window.innerWidth;
                const isMobileView = currentWidth < 768;
                const currentToolbar = editor.options.buttonList;

                if (isMobileView && (currentToolbar !== mobileToolbar)) {
                    editor.setOptions({ buttonList: mobileToolbar });
                    applyMobileFocusFix(); // Re-apply the fix after rebuilding the toolbar
                } else if (!isMobileView && (currentToolbar !== desktopToolbar)) {
                    editor.setOptions({ buttonList: desktopToolbar });
                }
            }, 100);
        });

        // A workaround for WebKit's selection issues.
        // This ensures that the selection is properly recognized before the editor's command is executed.
        editor.core.context.element.wysiwyg.addEventListener('touchend', function () {
            editor.core.context.element.wysiwyg.focus();
        });

    </script>

</body>
</html>